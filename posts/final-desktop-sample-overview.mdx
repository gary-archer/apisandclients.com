# Final Desktop App – Overview

Previously I explained some <Link href='/posts/desktop-app-coding-key-points'>Code Details</Link> for this blog's initial desktop app. Next I add some missing features to complete session management, harden security, and improve usability. The desktop app connects to <Link href='/posts/cloud-hosting'>HTTPS endpoints hosted in AWS</Link>, so that you only need to run the desktop app's code to get a fully integrated solution.

### New Features

The completed desktop code sample demonstrates these main features:

| Feature | Description |
| ------- | ----------- |
| <span style={{color:'green'}}>**React Update**</span> | I update from plain TypeScript to a more complete frontend technology stack. |
| <span style={{color:'green'}}>**Deep Linking**</span> | The app receieves login responses using private URI scheme based redirect URIs, to enable desktop deep links. |
| <span style={{color:'green'}}>**Secure Token Storage**</span> | I save OAuth tokens across app restarts using operating system encryption private to the app and user. |

### Code Download

Clone the code sample's GitHub repository with the following command:

```bash
git clone https://github.com/gary-archer/oauth.desktopsample.final
```

![repo](/images/440/repo.jpg?v=20240925)

### Run the Code Sample

After cloning the sample code, run the following commands to build and run the app:

```bash
./build.sh
./run.sh
```

Alternatively, you can build and run a packaged version of the app:

```bash
./pack.sh
```

### Updated Login Flow

Logins continue to use the system browser and the updated desktop app also implements OpenID Connect RP initiated logout.

![desktop login](/images/440/desktop-login.jpg?v=20240925)

You can use this blog’s test credential to sign in:

- User: *guestuser@example.com*
- Password: *GuestPassword1*

Once a login or logout completes, the browser renders a completion web page:

![login web page](/images/440/login-web-page.jpg?v=20240925)

When the user clicks *Return to the App*, the browser prevents a *Private URI Scheme* prompt. To understand its final appearance in the different browsers, run a packaged version of the app:


The desktop app is then brought to the foreground and can get data from the API using its access token:

![logged in](/images/440/logged-in.jpg?v=20240925)

After login, the app stores tokens in desktop secure storage. The user can restart the app without requiring a new user login, as long as its refresh token remains valid.

### OAuth Configuration Changes

The final desktop app’s configuration no longer uses HTTP ports, and now uses login and logout completion pages as redirect URIs:

```json
{
    "app": {
        "apiBaseUrl": "https://api.authsamples.com/investments",
        "useProxy": false,
        "proxyUrl": "http://127.0.0.1:8888"
    },
    "oauth": {
        "authority":             "https://cognito-idp.eu-west-2.amazonaws.com/eu-west-2_CuhLeqiE9",
        "clientId":              "5r463je7qeddssfqttaa8cpv91",
        "redirectUri":           "https://www.authsamples.com/apps/finaldesktopapp/postlogin.html",
        "postLogoutRedirectUri": "https://www.authsamples.com/apps/finaldesktopapp/postlogout.html",
        "scope":                 "openid profile https://api.authsamples.com/investments",
        "customLogoutEndpoint":  "https://login.authsamples.com/logout",
        "privateSchemeName":     "x-authsamples-desktopapp"
    }
}
```

When a deep link runs after a redirect, the browser may refuse to invoke it for security reasons, unless there is a user gesture. This is especially true if a redirect is entirely automatic, as for a single-sign-on or a logout. To prevent such issues you can use the OpenID Connect *prompt=none* parameter. However, this blog's default authorization server does not support that parameter so I instead set the app's redirect URIs to intermediate web pages.

### Intermediate Web Pages

The intermediate web pages run at the following internet URLs. They also improves a little on the default blank browser page that is otherwise displayed to the user after login.

- [https://www.authsamples.com/apps/finaldesktopapp/postlogin.html](https://www.authsamples.com/apps/finaldesktopapp/postlogin.html)
- [https://www.authsamples.com/apps/finaldesktopapp/postlogout.html](https://www.authsamples.com/apps/finaldesktopapp/postlogout.html)

I deployed the HTML pages to an AWS S3 Bucket and then made them used this blog's final SPA's AWS CloudFront distribution to make the web pages available over HTTPS:

![s3 pages](/images/440/s3-pages.jpg)

If you use your browser's *View Source* option you can see that the pages simply forward the login response to the app via its private URI scheme URL:

![response forwarding](/images/440/response-forwarding.jpg)

One downside of this approach is that, if the user doesn’t click the *Return to the App* button for a couple of minutes, the authorization code could time out, resulting in a user error. The user can always retry and recover though.

### Private URI Scheme Browser Prompts

All browsers recognize private URI schemes registered with the operating syastem and present a special prompt. For the final appearance, first build a packaged version of the desktop app:

```bash
./pack.sh
```

This results in a binary built by the [Electron Packager](https://github.com/electron/packager) to enable the built app to be tested:

![built binary](/images/440/built-binary.jpg)


**Google Chrome**

![chrome prompt](/images/440/chrome-prompt.jpg)

**Firefox**

![firefox prompt](/images/440/firefox-prompt.jpg)

**Edge**

![edge prompt](/images/440/edge-prompt.jpg)

**Safari**

![safari prompt](/images/440/safari-prompt.jpg)

### Final Cognito Desktop OAuth Client

A new OAuth client has been created, which registers the intermediate pages for the redirect URI and the post logout redirect URI:

![oauth client](/images/440/oauth-client.jpg)

### Private URI Scheme Registration

Our desktop app registers the Private URI Scheme as a per-user setting that does not require administrator privileges. On Windows this updates a per user registry location under *HKEY_CURRENT_USER*:

![windows registration](/images/440/windows-registration.jpg)

On macOS you can use the [SwiftDefaultApps](https://github.com/Lord-Kamina/SwiftDefaultApps) tool to view the scheme and the app it is registered to, which is also a per-user setting:

![macos registration](/images/440/macos-registration.jpg)

In my Linux distribution, the *Gnome Desktop System* controls custom schemes. Our sample includes a *.desktop* file with registration instructions:

```markdown
[Desktop Entry]
Type=Application
Name=Final Desktop App
Exec=$APP_COMMAND %U
StartupNotify=false
MimeType=x-scheme-handler/x-authsamples-desktopapp
```

To use private URI schemes you need to be able to restrict the desktop app to a single instance. In some desktop cases, such as for a *Microsoft Excel Plugin*, this may not be possible, and you will need to use a loopback based solution.

### Secure Token Storage

The desktop app stores OAuth tokens in an encrypted text file. [Electron safeStorage](https://www.electronjs.org/docs/latest/api/safe-storage) is used to create an operating system encryption key private to the user and app, for protecting the text. The result is that users do not need to login every time they restart the app.

On macOS the encryption key is saved to the Keychain. On Windows and Linux the key is less visible. Windows uses the *DPAPI* subsystem, and my Ubuntu Linux system uses the *GNOME libsecret* subsystem. Further details on the underlying security are discussed in [this online thread](https://github.com/microsoft/vscode-discussions/discussions/748).

![encryption key](/images/440/encryption-key.jpg)

The actual tokens are stored as base64 encrypted bytes in a JSON file at one of the following locations:

| Operating System | Stored Tokens Location |
| ---------------- | ---------------------- |
| <span style={{color:'green'}}>**Windows**</span> | ~/AppData/Roaming/finaldesktopapp/tokens.json |
| <span style={{color:'green'}}>**macOS**</span> | ~/Library/Application Support/finaldesktopapp/tokens.json |
| <span style={{color:'green'}}>**Linux (Gnome)**</span> | ~/.config/finaldesktopapp/tokens.json |

### Deep Linking to Views

The login and logout response messages received by the app are a type of deep link notification:

- *x-authsamples-desktopapp:/callback?code=…&state=…*
- *x-authsamples-desktopapp:/logoutcallback*

We can also use deep linking to bookmark screens, by sending a user an email with a URL link such as this:

- *x-authsamples-desktopapp:/companies/2*

The easiest way to test deep linking is from a command shell, and this varies slightly for the different operating systems:

| Operating System | Example Command |
| ---------------- | --------------- |
| <span style={{color:'green'}}>**Windows**</span> | start x-authsamples-desktopapp:/companies/2 |
| <span style={{color:'green'}}>**macOS**</span> | open x-authsamples-desktopapp:/companies/2 |
| <span style={{color:'green'}}>**Linux (Gnome)**</span> | xdg-open  x-authsamples-desktopapp:/companies/2 |

If the desktop app is running, this command will cause it to update its location to the *Transactions View* for our second company. If not then it will start up at that location:

![deep link](/images/440/deeplink.jpg)

If the user is logged in and has a valid access token, the app will move directly to the deep linking destination screen. Otherwise a token renewal or login will be triggered, followed by deep link navigation afterwards.

This blog’s APIs deny the default test user access to companies other than 2 and 4. Attempts to deep link to company 3 will fail API authorization and return a known error code. The desktop app handles this error specially, by returning the user to the list view:

![deep link unauthorized](/images/440/deeplink-unauthorized.jpg)

Finally, note that on macOS, startup deep links will only work if we first package the app with *npm run pack*, so that the scheme registration points to the packaged executable:

![macos packaged](/images/440/macos-packaged.jpg)a

- I provide a <Link href='/posts/final-desktop-app-coding-key-points'>Final Desktop App Code Details</Link>.
- For a list of all blog posts see the <Link href='/posts/index'>Index Page</Link>.
